<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Pretix Event Filters</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/webjars/font-awesome/css/all.min.css}">
    <script th:src="@{/webjars/axios/dist/axios.min.js}"></script>
    <script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4">Pretix Event Filters</h1>
    <div class="row align-items-center">
        <div class="col">
            <p>Incoming Webhooks from Pretix are checked against these filters. If there is no filter matching, the Webhook will not be processed.</p>
        </div>
        <div class="col-auto">
            <button onclick="openModal(null, 'edit')" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i> Add filter
            </button>
        </div>
    </div>
    <table class="table table-striped table-bordered">
        <thead class="thead-dark">
        <tr>
            <th>ID</th>
            <th>Action</th>
            <th>Organizer</th>
            <th>Event</th>
            <th>Filter Map</th>
            <th>Functions</th>
        </tr>
        </thead>
        <tbody id="eventFilters">
        <!-- Data will be injected here by JavaScript -->
        </tbody>
    </table>
</div>

<div class="modal fade" id="showDetailsFilterModal" tabindex="-1" aria-labelledby="showDetailsFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="showDetailsFilterModalLabel">Edit Filter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="saveFilterForm">
                    <input type="hidden" id="filterId">
                    <div class="mb-3">
                        <label for="filterAction" class="form-label">Action</label>
                        <input type="text" class="form-control" id="filterAction" required>
                    </div>
                    <div class="mb-3">
                        <label for="filterOrganizer" class="form-label">Organizer</label>
                        <input type="text" class="form-control" id="filterOrganizer" required>
                    </div>
                    <div class="mb-3">
                        <label for="filterEvent" class="form-label">Event</label>
                        <input type="text" class="form-control" id="filterEvent" required>
                    </div>
                    <div class="mb-3">
                        <label for="filterMap" class="form-label">Filter Map</label>
                        <textarea class="form-control" id="filterMap" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary float-end">Save changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Delete Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteConfirmationId"> <!-- Hidden input field to store the ID -->
                <p>Are you sure you want to delete this filter?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <!-- Pass the id directly to the confirmDelete function -->
                <button type="button" class="btn btn-danger" onclick="confirmDelete()" data-bs-dismiss="modal">Delete</button>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetchEventFilters();

        // Handle form submission
        document.getElementById('saveFilterForm').addEventListener('submit', function (event) {
            event.preventDefault();
            saveFilter();
        });
    });

    function fetchEventFilters() {
        axios.get('/api/v1/filter')
            .then(function (response) {
                const eventFilters = response.data;
                const tbody = document.getElementById('eventFilters');
                tbody.innerHTML = '';

                eventFilters.forEach(event => {
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td>${event.id}</td>
                        <td>${event.action}</td>
                        <td>${event.organizer}</td>
                        <td>${event.event}</td>
                        <td>
                            ${Object.entries(event['qna-list']).map(([key, value]) =>
                        `<p>${key}: ${value.join(', ')}</p>`
                    ).join('')}
                        </td>
                        <td>
                            <button onclick="openModal(${event.id}, 'view')" class="btn btn-primary btn-sm">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="openModal(${event.id}, 'edit')" class="btn btn-secondary btn-sm">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="showDeleteConfirmation(${event.id})" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
            })
            .catch(function (error) {
                console.error('There was an error fetching the event filters!', error);
            });
    }

    function showDeleteConfirmation(id) {
        // Store the ID in a hidden input field in the modal
        document.getElementById('deleteConfirmationId').value = id;
        // Show the modal
        new bootstrap.Modal(document.getElementById('deleteConfirmationModal')).show();
    }

    // Function to handle confirmed deletion
    function confirmDelete() {
        // Retrieve the ID from the hidden input field in the modal
        const id = document.getElementById('deleteConfirmationId').value;

        // Send HTTP DELETE request to delete the filter
        axios.delete(`/api/v1/filter/${id}`)
            .then(function () {
                // Log success message
                console.log('Filter deleted successfully');

                // Close modal after deletion
                new bootstrap.Modal(document.getElementById('deleteConfirmationModal')).hide();

                // Optionally, you can refresh the table after deletion
                fetchEventFilters();

            })
            .catch(function (error) {
                // Log error message
                console.error('Error deleting filter:', error);
            });
    }

    function openModal(id, mode) {
        if (id) {
            // Fetch filter details if ID is provided
            axios.get(`/api/v1/filter/${id}`)
                .then(function (response) {
                    const filter = response.data;
                    document.getElementById('filterId').value = filter.id;
                    document.getElementById('filterAction').value = filter.action;
                    document.getElementById('filterOrganizer').value = filter.organizer;
                    document.getElementById('filterEvent').value = filter.event;
                    document.getElementById('filterMap').value = JSON.stringify(filter['qna-list'], null, 2);

                    const modalLabel = document.getElementById('showDetailsFilterModalLabel');
                    const submitButton = document.querySelector('#saveFilterForm button[type="submit"]');

                    if (mode === 'view') {
                        modalLabel.innerText = 'View Filter';
                        submitButton.style.display = 'none';
                        setFormReadOnly(true);
                    } else if (mode === 'edit') {
                        modalLabel.innerText = 'Edit Filter';
                        submitButton.style.display = 'block';
                        setFormReadOnly(false);
                    }

                    new bootstrap.Modal(document.getElementById('showDetailsFilterModal')).show();
                })
                .catch(function (error) {
                    console.error('There was an error fetching the filter details!', error);
                });
        } else {
            // Open an empty modal for creating a new filter
            document.getElementById('filterId').value = '';
            document.getElementById('filterAction').value = '';
            document.getElementById('filterOrganizer').value = '';
            document.getElementById('filterEvent').value = '';
            document.getElementById('filterMap').value = '';

            const modalLabel = document.getElementById('showDetailsFilterModalLabel');
            const submitButton = document.querySelector('#saveFilterForm button[type="submit"]');

            modalLabel.innerText = 'Add Filter'; // Change modal title
            submitButton.style.display = 'block'; // Show submit button
            setFormReadOnly(false); // Enable form fields

            new bootstrap.Modal(document.getElementById('showDetailsFilterModal')).show();
        }
    }


    function setFormReadOnly(isReadOnly) {
        const formElements = document.querySelectorAll('#saveFilterForm input, #saveFilterForm textarea');
        formElements.forEach(element => {
            element.readOnly = isReadOnly;
        });
    }

    function saveFilter() {
        const id = document.getElementById('filterId').value;
        const action = document.getElementById('filterAction').value;
        const organizer = document.getElementById('filterOrganizer').value;
        const event = document.getElementById('filterEvent').value;
        const filterMap = JSON.parse(document.getElementById('filterMap').value);

        // Define the request data
        const requestData = {
            action: action,
            organizer: organizer,
            event: event,
            'qna-list': filterMap
        };

        // Define the URL for the request
        const url = id ? `/api/v1/filter/${id}` : `/api/v1/filter`;

        // Define the HTTP method for the request
        const method = id ? 'PUT' : 'POST';

        // Send the request
        axios({
            method: method,
            url: url,
            data: requestData
        })
            .then(function () {
                fetchEventFilters();
                bootstrap.Modal.getInstance(document.getElementById('showDetailsFilterModal')).hide();
            })
            .catch(function (error) {
                console.error('There was an error saving the filter!', error);
            });
    }

</script>
</body>
</html>
