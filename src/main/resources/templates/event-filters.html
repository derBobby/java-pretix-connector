<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Pretix Event Filters</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/webjars/font-awesome/css/all.min.css}">
    <script th:src="@{/webjars/axios/dist/axios.min.js}"></script>
    <script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4">Pretix Event Filters</h1>
    <div class="row align-items-center">
        <div class="col">
            <p>Incoming Webhooks from Pretix are checked against these filters. If there is no filter matching, the Webhook will not be processed.</p>
        </div>
        <div class="col-auto">
            <button onclick="openModal(null, 'edit')" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i> Add filter
            </button>
        </div>
    </div>
    <table class="table table-striped table-bordered">
        <thead class="thead-dark">
        <tr>
            <th>ID</th>
            <th>Action</th>
            <th>Organizer</th>
            <th>Event</th>
            <th>Filter Map</th>
            <th>Functions</th>
        </tr>
        </thead>
        <tbody id="eventFilters">
        <!-- Data will be injected here by JavaScript -->
        </tbody>
    </table>
</div>

<div class="modal fade" id="showDetailsFilterModal" tabindex="-1" aria-labelledby="showDetailsFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="showDetailsFilterModalLabel">Edit Filter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="saveFilterForm">
                    <input type="hidden" id="filterId">
                    <div class="mb-3">
                        <label for="filterAction" class="form-label">Action</label>
                        <select class="form-control" id="filterAction" required>
                            <option th:each="action : ${pretixSupportedActions}" th:value="${action.action}" th:text="${action.description}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="filterOrganizer" class="form-label">Organizer</label>
                        <input type="text" class="form-control" id="filterOrganizer" required>
                    </div>
                    <div class="mb-3">
                        <label for="filterEvent" class="form-label">Event</label>
                        <input type="text" class="form-control" id="filterEvent" required>
                    </div>
                    <div class="mb-3">
                        <label for="filterMap" class="form-label">Filter Map</label>
                        <div id="filterMapContainer">
                            <div class="row mb-2">
                                <div class="col-5">
                                    <input type="text" class="form-control" placeholder="Key">
                                </div>
                                <div class="col-6">
                                    <input type="text" class="form-control" placeholder="Value (comma-separated)">
                                </div>
                                <div class="col-1">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeFilterRow(this)">
                                        -
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-success btn-sm" onclick="addFilterRow()">Add Row</button>

                    </div>
                    <button type="submit" class="btn btn-primary float-end">Save changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Delete Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteConfirmationId">
                <p>Are you sure you want to delete this filter?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()" data-bs-dismiss="modal">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetchEventFilters();

        // Handle form submission
        document.getElementById('saveFilterForm').addEventListener('submit', function (event) {
            event.preventDefault();
            saveFilter();
        });
    });

    function fetchEventFilters() {
        axios.get('/api/v1/filter')
            .then(function (response) {
                const eventFilters = response.data;
                const tbody = document.getElementById('eventFilters');
                tbody.innerHTML = '';

                eventFilters.forEach(event => {
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td>${event.id}</td>
                        <td>${event.action}</td>
                        <td>${event.organizer}</td>
                        <td>${event.event}</td>
                        <td>
                            ${Object.entries(event['qna-list']).map(([key, value]) =>
                        `<p>${key}: ${value.join(', ')}</p>`
                    ).join('')}
                        </td>
                        <td>
                            <button onclick="openModal(${event.id}, 'view')" class="btn btn-primary btn-sm">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="openModal(${event.id}, 'edit')" class="btn btn-secondary btn-sm">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="showDeleteConfirmation(${event.id})" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
            })
            .catch(function (error) {
                console.error('There was an error fetching the event filters!', error);
            });
    }

    function showDeleteConfirmation(id) {
        document.getElementById('deleteConfirmationId').value = id;
        new bootstrap.Modal(document.getElementById('deleteConfirmationModal')).show();
    }

    function confirmDelete() {
        const id = document.getElementById('deleteConfirmationId').value;

        axios.delete(`/api/v1/filter/${id}`)
            .then(function () {
                console.log('Filter deleted successfully');
                bootstrap.Modal.getInstance(document.getElementById('deleteConfirmationModal')).hide();
                fetchEventFilters();
            })
            .catch(function (error) {
                console.error('Error deleting filter:', error);
            });
    }

    function openModal(id, mode) {
        if (id) {
            axios.get(`/api/v1/filter/${id}`)
                .then(function (response) {
                    const filter = response.data;
                    document.getElementById('filterId').value = filter.id;
                    document.getElementById('filterAction').value = filter.action;
                    document.getElementById('filterOrganizer').value = filter.organizer;
                    document.getElementById('filterEvent').value = filter.event;

                    // Populate filterMap rows
                    populateFilterMap(filter['qna-list']);

                    const modalLabel = document.getElementById('showDetailsFilterModalLabel');
                    const submitButton = document.querySelector('#saveFilterForm button[type="submit"]');

                    if (mode === 'view') {
                        modalLabel.innerText = 'View Filter';
                        submitButton.style.display = 'none';
                        setFormReadOnly(true);
                    } else if (mode === 'edit') {
                        modalLabel.innerText = 'Edit Filter';
                        submitButton.style.display = 'block';
                        setFormReadOnly(false);
                    }

                    new bootstrap.Modal(document.getElementById('showDetailsFilterModal')).show();
                })
                .catch(function (error) {
                    console.error('There was an error fetching the filter details!', error);
                });
        } else {
            document.getElementById('filterId').value = '';
            document.getElementById('filterAction').value = '';
            document.getElementById('filterOrganizer').value = '';
            document.getElementById('filterEvent').value = '';

            // Clear filterMap rows
            populateFilterMap({});

            const modalLabel = document.getElementById('showDetailsFilterModalLabel');
            const submitButton = document.querySelector('#saveFilterForm button[type="submit"]');

            modalLabel.innerText = 'Add Filter';
            submitButton.style.display = 'block';
            setFormReadOnly(false);

            new bootstrap.Modal(document.getElementById('showDetailsFilterModal')).show();
        }
    }

    function populateFilterMap(filterMap) {
        const filterMapContainer = document.getElementById('filterMapContainer');
        filterMapContainer.innerHTML = ''; // Clear existing rows

        if (filterMap && typeof filterMap === 'object') {
            for (const [key, values] of Object.entries(filterMap)) {
                addFilterRow(key, values.join(', '));
            }
        } else {
            addFilterRow(); // Add an initial empty row if no data
        }
    }

    function setFormReadOnly(readOnly) {
        const formElements = document.querySelectorAll('#saveFilterForm input, #saveFilterForm select, #saveFilterForm textarea, #saveFilterForm button');
        formElements.forEach(function (element) {
            if (readOnly) {
                element.setAttribute('disabled', 'disabled');
            } else {
                element.removeAttribute('disabled');
            }
        });

        // Enable the close button even in view mode
        document.querySelector('.btn-close').removeAttribute('disabled');
    }

    function saveFilter() {
        const id = document.getElementById('filterId').value;
        const action = document.getElementById('filterAction').value;
        const organizer = document.getElementById('filterOrganizer').value;
        const event = document.getElementById('filterEvent').value;
        let filterMap;

        resetFormFields();

        try {
            filterMap = parseFilterMap();
        } catch (e) {
            displayJsonError('Invalid JSON format in Filter Map');
            return;
        }

        const requestData = {
            id: id,
            action: action,
            organizer: organizer,
            event: event,
            'qna-list': filterMap
        };

        const url = id ? `/api/v1/filter/${id}` : `/api/v1/filter`;
        const method = id ? 'PUT' : 'POST';

        axios({
            method: method,
            url: url,
            data: requestData
        })
            .then(function () {
                fetchEventFilters();
                bootstrap.Modal.getInstance(document.getElementById('showDetailsFilterModal')).hide();
            })
            .catch(function (error) {
                if (error.response) {
                    if (error.response.status === 400) {
                        const errors = error.response.data;
                        handleFormErrors(errors);
                    } else {
                        console.error('Server Error:', error.response.data);
                    }
                } else if (error.request) {
                    console.error('No response received:', error.request);
                } else {
                    console.error('Error:', error.message);
                }
            });
    }

    function displayJsonError(errorMessage) {
        const filterMapContainer = document.getElementById('filterMapContainer');
        const invalidFeedback = document.createElement('div');
        invalidFeedback.className = 'invalid-feedback d-block';
        invalidFeedback.textContent = errorMessage;
        filterMapContainer.appendChild(invalidFeedback);
    }

    function handleFormErrors(errors) {
        Object.keys(errors).forEach(function (fieldName) {
            const errorMessage = errors[fieldName];
            const inputField = document.getElementById(`filter${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}`);

            // Add error message
            inputField.classList.add('is-invalid');
            const invalidFeedback = document.createElement('div');
            invalidFeedback.className = 'invalid-feedback';
            invalidFeedback.textContent = errorMessage;
            inputField.parentElement.appendChild(invalidFeedback);
        });
    }

    function resetFormFields() {
        document.querySelectorAll('.is-invalid').forEach(function (input) {
            input.classList.remove('is-invalid');
            const errorMessage = input.parentElement.querySelector('.invalid-feedback');
            if (errorMessage) {
                errorMessage.remove();
            }
        });

        // Reset filter map rows
        const filterMapContainer = document.getElementById('filterMapContainer');
        filterMapContainer.innerHTML = '';
        addFilterRow(); // Add an initial row
    }

    function handleModalClose() {
        resetFormFields();
    }

    function addFilterRow(key = '', value = '') {
        const filterMapContainer = document.getElementById('filterMapContainer');
        const row = document.createElement('div');
        row.className = 'row mb-2';

        row.innerHTML = `
        <div class="col-5">
            <input type="text" class="form-control" placeholder="Key" value="${key}">
        </div>
        <div class="col-6">
            <input type="text" class="form-control" placeholder="Value (comma-separated)" value="${value}">
        </div>
        <div class="col-1">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeFilterRow(this)">-</button>
        </div>
    `;

        filterMapContainer.appendChild(row);
    }

    function removeFilterRow(button) {
        const row = button.closest('.row');
        row.remove();
    }

    function parseFilterMap() {
        const filterMapContainer = document.getElementById('filterMapContainer');
        const rows = filterMapContainer.querySelectorAll('.row');
        const filterMap = {};

        rows.forEach(row => {
            const key = row.querySelector('input[placeholder="Key"]').value.trim();
            const value = row.querySelector('input[placeholder="Value (comma-separated)"]').value.trim();
            if (key && value) {
                filterMap[key] = value.split(',').map(v => v.trim());
            }
        });

        return filterMap;
    }

    document.getElementById('showDetailsFilterModal').addEventListener('hidden.bs.modal', handleModalClose);
</script>
</body>
</html>
