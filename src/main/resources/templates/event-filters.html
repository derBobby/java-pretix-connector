<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Pretix Event Filters</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/webjars/font-awesome/css/all.min.css}">
    <script th:src="@{/webjars/axios/dist/axios.min.js}"></script>
    <script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4">Pretix Event Filters</h1>
    <div class="row align-items-center">
        <div class="col">
            <p>Incoming Webhooks from Pretix are checked against these filters. If there is no filter matching, the Webhook will not be processed.</p>
        </div>
        <div class="col-auto ms-auto">
            <a href="" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i> Add filter
            </a>
        </div>
    </div>
    <table class="table table-striped table-bordered">
        <thead class="thead-dark">
        <tr>
            <th>ID</th>
            <th>Action</th>
            <th>Organizer</th>
            <th>Event</th>
            <th>Filter Map</th>
            <th>Functions</th>
        </tr>
        </thead>
        <tbody id="eventFilters">
        <!-- Data will be injected here by JavaScript -->
        </tbody>
    </table>
</div>

<div class="modal fade" id="editFilterModal" tabindex="-1" aria-labelledby="editFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editFilterModalLabel">Edit Filter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editFilterForm">
                    <input type="hidden" id="filterId">
                    <div class="mb-3">
                        <label for="filterAction" class="form-label">Action</label>
                        <input type="text" class="form-control" id="filterAction" required>
                    </div>
                    <div class="mb-3">
                        <label for="filterOrganizer" class="form-label">Organizer</label>
                        <input type="text" class="form-control" id="filterOrganizer" required>
                    </div>
                    <div class="mb-3">
                        <label for="filterEvent" class="form-label">Event</label>
                        <input type="text" class="form-control" id="filterEvent" required>
                    </div>
                    <div class="mb-3">
                        <label for="filterMap" class="form-label">Filter Map</label>
                        <textarea class="form-control" id="filterMap" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetchEventFilters();

        // Handle form submission
        document.getElementById('editFilterForm').addEventListener('submit', function (event) {
            event.preventDefault();
            saveFilter();
        });
    });

    function fetchEventFilters() {
        axios.get('/api/v1/filter')
            .then(function (response) {
                const eventFilters = response.data;
                const tbody = document.getElementById('eventFilters');
                tbody.innerHTML = '';

                eventFilters.forEach(event => {
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td>${event.id}</td>
                        <td>${event.action}</td>
                        <td>${event.organizer}</td>
                        <td>${event.event}</td>
                        <td>
                            ${Object.entries(event['qna-list']).map(([key, value]) =>
                        `<p>${key}: ${value.join(', ')}</p>`
                    ).join('')}
                        </td>
                        <td>
                            <a href="/api/v1/filter/${event.id}" class="btn btn-primary btn-sm">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button onclick="openEditModal(${event.id})" class="btn btn-secondary btn-sm">
                                <i class="fas fa-edit"></i>
                            </button>
                            <form onsubmit="return deleteEventFilter(${event.id});" style="display:inline;">
                                <input type="hidden" name="_method" value="delete"/>
                                <button type="submit" class="btn btn-danger btn-sm">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
            })
            .catch(function (error) {
                console.error('There was an error fetching the event filters!', error);
            });
    }

    function deleteEventFilter(id) {
        if (!confirm('Are you sure you want to delete this filter?')) {
            return false;
        }

        axios.delete(`/api/v1/filter/${id}`)
            .then(function () {
                fetchEventFilters();
            })
            .catch(function (error) {
                console.error('There was an error deleting the event filter!', error);
            });

        return false;
    }

    function openEditModal(id) {
        axios.get(`/api/v1/filter/${id}`)
            .then(function (response) {
                const filter = response.data;
                document.getElementById('filterId').value = filter.id;
                document.getElementById('filterAction').value = filter.action;
                document.getElementById('filterOrganizer').value = filter.organizer;
                document.getElementById('filterEvent').value = filter.event;
                document.getElementById('filterMap').value = JSON.stringify(filter['qna-list'], null, 2);
                new bootstrap.Modal(document.getElementById('editFilterModal')).show();
            })
            .catch(function (error) {
                console.error('There was an error fetching the filter details!', error);
            });
    }

    function saveFilter() {
        const id = document.getElementById('filterId').value;
        const action = document.getElementById('filterAction').value;
        const organizer = document.getElementById('filterOrganizer').value;
        const event = document.getElementById('filterEvent').value;
        const filterMap = JSON.parse(document.getElementById('filterMap').value);

        axios.put(`/api/v1/filter/${id}`, {
            action: action,
            organizer: organizer,
            event: event,
            'qna-list': filterMap
        })
            .then(function () {
                fetchEventFilters();
                bootstrap.Modal.getInstance(document.getElementById('editFilterModal')).hide();
            })
            .catch(function (error) {
                console.error('There was an error saving the filter!', error);
            });
    }
</script>
</body>
</html>
